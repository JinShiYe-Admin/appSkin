<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport"
			content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/common.css" rel="stylesheet" />
		<style>
			[v-cloak] {
				visibility: hidden;
				display: none !important;
			}

			html,
			body {
				background-color: #efeff4;
			}

			.mui-bar~.mui-content .mui-fullscreen {
				top: 44px;
				height: auto;
			}
			
			.mui-scroll-wrapper{
				background: #FFFFFF;
			}
			
			.mui-scroll-wrapper{
				padding: 0px;
				border-right: 1px solid #EAEAEA;
			}
			
			.mui-table-view:before,.mui-table-view:after,.mui-table-view-cell:before,.mui-table-view-cell:after,.mui-input-group .mui-input-row:after,.mui-input-group:before,.mui-input-group:after {
			    height: 0px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" id="tempVue">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">{{titleName}}</h1>
			<a @click.stop="sure()" class="mui-pull-right" style="font-size: 14px;margin-top: 0px;">确定</a>
		</header>
		<div id="datasource" class="mui-content mui-fullscreen" style="z-index:0" v-cloak>
			<div class="mui-row">
				<div class="mui-col-xs-5">
					<div class="mui-scroll-wrapper" :style="{height:windowHeight}" v-cloak>
						<div class="mui-scroll">
							<div class="scroll-body" >
								 <ul class="mui-table-view" v-cloak>
								 	<li class="mui-table-view-cell mui-collapse" v-for="model in pageArray" @tap="clickGrdLi($event,model)">
								 		<a class="mui-navigate-right" href="#">{{model.dpt_name}}</a>
								 		<div class="mui-collapse-content">
								 			<ul v-else class="mui-table-view" style="margin-top: -7px;margin-left: -30px;" v-cloak>
								 				<li v-for="clsmodel in model.children" class="mui-table-view-cell"  @tap.stop="clickClsLi($event,model,clsmodel)">
								 					<span v-if="clsmodel.checked" style="color: #00CFBD !important;padding-left: 10px;">{{clsmodel.dpt_name}}</span>
													<span v-else style="padding-left: 10px;">{{clsmodel.dpt_name}}</span> 
								 				</li>
								 			</ul>
								 		</div>
								 	</li>
								 </ul>
							</div>
						</div>
					</div>
				</div>
				<div class="mui-col-xs-7">
					<div class="mui-scroll-wrapper" :style="{height:windowHeight}" v-cloak>
						<div class="mui-scroll">
							<div class="scroll-body" >
								<!-- <template v-if="cClicked">
									<template v-if="stuArray.length>0">
										<form class="mui-input-group">
											<template v-for="item in stuArray">
												<div class="mui-input-row mui-checkbox mui-left">
													<label>{{item.stu_name}}</label>
													<input name="checkbox" :value="item.stu_code" type="checkbox" :checked="item.checked" @click="stuClick(item)">
												</div>
											</template>
										</form>
									</template>
									<template v-else>
										<div style="margin:10px 10px 0;">暂无学生</div>
									</template>
								</template>
								<template v-else>
									<div style="margin:10px 10px 0;">请选择班级</div>
								</template> -->
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script src="../../js/utils/mui.js"></script>
		<script src="../../js/utils/storageKeyName.js"></script>
		<script src="../../js/utils/vconsole.min.js"></script>
		<script src="../../js/utils/vue.js"></script>
		<script src="../../js/utils/publicProtocol.js"></script>
		<script src="../../js/utils/store.js"></script>
		<script src="../../js/utils/utils.js"></script>
		<script src="../../js/utils/events.js"></script>
		<!--加密-->
		<script src="../../js/libs/RSA/Barrett.js"></script>
		<script src="../../js/libs/RSA/BigInt.js"></script>
		<script src="../../js/libs/RSA/RSA.js"></script>
		<script src="../../js/libs/encryption/RSAEncrypt.js"></script>
		<script src='../../js/libs/crypto-js/require.js'></script>
		<script src='../../js/libs/encryption/signHmacSHA1.js'></script>
		<script src='../../js/libs/jquery.js'></script>
		<script src='../../js/libs/encryption/sortSign.js'></script>
		<script type="text/javascript">
			//获取个人信息
			var personal = store.get(window.storageKeyName.PERSONALINFO);
			// console.log('personal:' + JSON.stringify(personal));
			var curPage = {};
			var pageIndex = 1; //请求数据页面
			var totalPageCount; //总页码
			var flagRef = 0; //是刷新0，还是加载更多1
			var tempVue = new Vue({
				el: "#tempVue",
				data: {
					titleName: ''
				},
				methods: {
					sure: function() {
						let checkedStu=[]
						let checkedStuNames=[]
						datasource.pageArray.map(grdItem=>{
							let gname=grdItem.name
							grdItem.clsArray.map(clsItem=>{
								let cname=clsItem.name
								let names=[]
								clsItem.stuArray.map(stuItem=>{
									if(stuItem.checked){
										checkedStu.push(stuItem)
										names.push(stuItem.stu_name)
									}
								})
								if(names.length>0){
									checkedStuNames.push(gname+" "+cname+":"+names.join(","))	
								}
							})
						})
						mui.fire(plus.webview.currentWebview().opener(), 'refreshStudent', [checkedStu,checkedStuNames]);
						setTimeout(function() {
							mui.back()
						}, 100)
					}
				}
			});
			var datasource = new Vue({
				el: "#datasource",
				data: {
					windowHeight: '0', //窗口高度
					grdSelect:{},
					clsSelect:{},
					cClicked:false,
					pageArray: [] ,//界面年级班级总数组
					stuArray:[],//学生数组
				},
				methods: {
					clickGrdLi: function(e,model) {
						this.grdSelect=model
					},
					clickClsLi:function(e,gmodel,model){
						if(this.clsSelect.value===model.value){
							return
						}
						this.grdSelect=gmodel
						datasource.pageArray.map(gm=>{
							gm.clsArray.map(item=>{
								item.checked=false
							})
						})
						model.checked=true
						this.clsSelect=model
						this.cClicked=true
						let pageArray=datasource.pageArray
						let serviced=curPage.serviced
						console.log(JSON.stringify(curPage));
						pageArray.map(grdItem=>{							if(grdItem.value===gmodel.value){								grdItem.clsArray.map(clsItem=>{									if(clsItem.value===model.value){
										if(clsItem.loaded){
											datasource.stuArray=clsItem.stuArray
										}else{
											if(serviced=='99'){
												getStuArray()
											}else if(serviced=='0'){
												getStuUnDGArray()
											}else if(serviced=='1'){
												getStuDGArray();
											}else{
												getStuDGArray();
											}
										}									}								})							}						})
					},
					stuClick:function(stu){
						stu.checked=!stu.checked
					}
				}
			});
			mui.init();

			mui.plusReady(function() {
				curPage = utils.getDataFromUrl(window.location.href);
				// console.log('2222:' + JSON.stringify(curPage));
				datasource.windowHeight = document.body.clientHeight-45  + 'px'
				tempVue.titleName = curPage.name;
				var deceleration = mui.os.ios ? 0.003 : 0.0009;
				mui('.mui-scroll-wrapper').scroll({
					bounce: false,
					indicators: true, //是否显示滚动条
					deceleration: deceleration
				});
				events.showWaiting();
				getDpt();
			});
			
			//获取学校部门
			function getDpt(){
				const params = {
					sch_code:personal.unit_code,
					index_code: curPage.index_code,
				}
				postDataEncry(window.storageKeyName.INTERFACE_HR_SUB + 'dpt', {}, params, 2, function(data) {
					events.closeWaiting();
					if (data.code == 0) {
						 datasource.pageArray=getDptTree(data.data.list);
					}else{
						mui.toast(data.msg);
					}
				});
			} 
			
			
			//获取学校有账号的部门人员
			function getDptUser(dpt_code){
				const params = {
					sch_code:personal.unit_code,
					dpt_codes:dpt_code,
					uid_stat:1,
					page_size:1,
					page_number:-1,
					index_code: curPage.index_code,
				}
				postDataEncry(window.storageKeyName.INTERFACE_HR_SUB + 'dptUser', {}, params, 2, function(data) {
					console.log('啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊：'+JSON.stringify(data))
					events.closeWaiting();
					if (data.code == 0) {
						
					}else{
						mui.toast(data.msg);
					}
				});
			} 
			getDptTree=(dptList)=>{
			    const map = {};
			    const val = [];
			    dptList.forEach((item) => {
			      map[item.dpt_code] = item;
			    });
			    dptList.forEach((item) => {
			      const parent = map[item.pcode];
			      if (parent) {
			        (parent.children || (parent.children = [])).push(item);
			      } else {
			        val.push(item);
			      }
			    });
			    return val
			  }
		</script>
	</body>

</html>
